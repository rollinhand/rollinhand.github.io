<!-- HTML5 HEADER WITH NAVIGATION -->
<!DOCTYPE html>
<html lang="de">
<head>
  <!-- HTML metadata and includes -->
  <!-- Header information like meta information and script resources -->
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, maximum-scale=1">

  <link rel="icon" href="../../../../../images/favicon.png" type="image/png">
  <link rel="shortcut icon" href="../../../../../images/favicon.png" type="image/png">

  <!-- Stylesheets -->
  <link href="../../../../../css/styles.css" rel="stylesheet" type="text/css">
  <link href="../../../../../css/github.css" rel="stylesheet" type="text/css">
  <!-- Bootstrap icons-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Feeds -->
  <link rel="alternate" type="application/atom+xml" title="Atom" href="../../../../../feed.xml" />

  <!-- Load Highlight.js -->
  <script src="../../../../../js/highlight.pack.js"></script>
  <title>Maven Surefire und Probleme mit dem Classpath</title>
</head>
<body class="d-flex flex-column h-100">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container px-5">
      <a class="navbar-brand" href="../../../../../index.html"><img class="logo" src="../../../../../images/kivio-white.png" alt="Logo"></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mb-2 mx-1 mb-lg-0">
            <li class="nav-item mx-1 ">
              <a class="nav-link " href="../../../../../category/allgemein/index.html">Allgemein</a>
            </li>
            <li class="nav-item mx-1 ">
              <a class="nav-link " href="../../../../../category/devops/index.html">DevOps</a>
            </li>
            <li class="nav-item mx-1 ">
              <a class="nav-link " href="../../../../../category/entwicklung/index.html">Entwicklung</a>
            </li>
            <li class="nav-item mx-1 ">
              <a class="nav-link " href="../../../../../category/technologie/index.html">Technologie</a>
            </li>
        </ul>
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
<a href="../../../../../about/index.html">
    <img class="avatar avatar-small" alt="rollinhand" width="40" height="40" data-proofer-ignore="true"
         src="https://avatars2.githubusercontent.com/rollinhand?v=3&s=40"
         srcset="https://avatars2.githubusercontent.com/rollinhand?v=3&s=40 1x, https://avatars2.githubusercontent.com/rollinhand?v=3&s=80 2x, https://avatars2.githubusercontent.com/rollinhand?v=3&s=120 3x, https://avatars2.githubusercontent.com/rollinhand?v=3&s=160 4x"/></a>        </ul>
      </div>
    </div>
  </nav>
<main class="flex-shrink-0">
	<!-- Page Content-->
	<section class="py-5">
		<div class="container px-5 my-5">
			<div class="row gx-5">
				<div class="col-lg-3">
					<div class="d-flex align-items-center mt-lg-5 mb-4">
<a href="../../../../../about/index.html">
    <img class="avatar avatar-small" alt="rollinhand" width="40" height="40" data-proofer-ignore="true"
         src="https://avatars2.githubusercontent.com/rollinhand?v=3&s=40"
         srcset="https://avatars2.githubusercontent.com/rollinhand?v=3&s=40 1x, https://avatars2.githubusercontent.com/rollinhand?v=3&s=80 2x, https://avatars2.githubusercontent.com/rollinhand?v=3&s=120 3x, https://avatars2.githubusercontent.com/rollinhand?v=3&s=160 4x"/></a>						<div class="small ms-3">
							<div class="fw-bold">Björn Berg</div>
						</div>
					</div>
					<!-- Hinweis auf fremden Blog-Artikel -->
				</div>
				<div class="col-lg-9">
					<!-- Post content-->
					<article>
						<!-- Post header-->
						<header class="mb-4">
							<!-- Post title-->
							<h1 class="fw-bolder mb-1">Maven Surefire und Probleme mit dem Classpath</h1>
							<!-- Post meta content-->
							<div class="text-muted fst-italic mb-2">29.05.2020</div>
							<!-- Post categories-->
								<a class="badge bg-primary text-decoration-none link-light" href="/category/entwicklung">Entwicklung</a>
							<!-- Post tags -->
									<span class="badge bg-secondary text-decoration-none link-light">Maven</span>
									<span class="badge bg-secondary text-decoration-none link-light">Eclipse</span>
						</header>
						<!-- Post content-->
						<section class="mb-5">
							<p>In meinem letzten Projekt beim Kunden bin ich auf ein interessantes Problem im Maven Surefire Plugin gestoßen. Während meine Unit-Tests in der Eclipse-Umgebung problemlos liefen, warf Maven auf der Kommandozeile beim Aufruf von <code>Class.forName()</code> eine ClassNotFoundException. Was war da los?</p>
<!--more-->
<h2>Der zu testende Code</h2>
<p>Die zu testende Code-Passage, die mit Maven Surefire und Junit 4.12 auf der Kommandozeile immer wieder fehlegschlagen ist, sah in etwa so aus:</p>
<pre><code class="language-java">final String className = &quot;org.kivio.depot.Isin&quot;
Class&lt;?&gt; clazz = (Class&lt;?&gt;)Class.forName(className);
</code></pre>
<p>An dieser Stelle zunächst nichts besonderes. Die Klasse <code>Isin</code> befindet sich allerdings in einem als Dependency deklarierten Jar-File, dass für den Test benötigt wird.</p>
<h2>Die Besonderheit von Maven Surefire</h2>
<p>Seit <a href="surefire">Maven Surefire 2.8.2</a> ist die Behandlung des Classpath und somit auch die Testausführung geändert worden. Standardmäßig ist der System Class Loader aktiv und Maven Surefire startet alle Tests mit einem Manifest-Only JAR.</p>
<p>Hierbei wird ein temporäres JAR erzeugt, dass nur den Inhalt <code>META-INF/MANIFEST.MF</code> enthält. In dem MANIFEST sind über das Attribut <em>Class_Path</em> alle notwendigen Abhängigkeiten für die Testausführung mit ihren absoluten Pfaden gesetzt.</p>
<p>Und hier kommen wir zum eigentlichen Problem=System Class Loader, Thread Context Class Loader und der Default Class Loader sind identisch und verweisen auf das Maven Surefire Booter JAR, das wiederum Einträge zu den JAR-Dateien mit Klassen enthält, die in einem anderen Kontext geladen worden sind.</p>
<p>Wenn eine Anwendung ihren Class Loader selbst nach JAR-Dateien oder Klassen befragt, ist es besser, wenn ein isolierter Class Loader genutzt wird, der alle Abhängigkeiten kennt. Das wäre in diesem Fall der korrekte Weg, um den Test zu starten und auf den System Class Loader zu setzen. Dies kann aber gerade im Embedded Kontext - also wenn Maven in einer IDE gestartet wird - wiederum zu anderen Problemen führen.</p>
<p>Ein weiterer Grund doch eher auf den Manifest-Only-Ansatz zu setzen, ist die Möglichkeit, dass Surefire Tests parallel ausführen kann und daher Forks vom Hauptprozess erstellt. Beim Forken scheinen allerdings die Class Loader durcheinander zu kommen und die Wiederverwendung eines Forks durch Surefire sollte unterbunden werden. Und mit exakt diesem Ansatz kann das Class Loading-Problem umgangen werden.</p>
<h2>Ein Parameter bringt die Rettung</h2>
<p>Eine einfache Änderung der Konfiguration des Surefire-Plugins sorgt dafür, dass <code>Class.forName</code>-Anweisungen im zu testenden Code funktionieren:</p>
<pre><code class="language-xml">&lt;plugin&gt;
  &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
  &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
  &lt;configuration&gt;
    &lt;reuseForks&gt;false&lt;/reuseForks&gt;
  &lt;/configuration&gt;
&lt;/plugin&gt;
</code></pre>
<p>Mit <code>reuseForks</code> kann gesteuert werden, ob Surefire einen geforkten Prozess für einen weiteren Unit Test wiederverwenden soll. Durch die Unterbindung wird für jeden Testfall ein neuer Prozess gestartet und der Classpath korrekt gesetzt.</p>
<p>Allerdings hat dieses Vorgehen auch einen gravierenden Nachteil, der nicht verschwiegen werden sollte=Bei vielen durchzuführenden Tests kommt die Garbage Collection ggf. nicht nach und es kommt zu einem Überschreiten des GC Overhead Limits.</p>
<p>Die Option sollte also mit Vorsicht gesetzt werden.</p>

						</section>
					</article>
					<section>
						<div class="card bg-light">
							<div class="card-body">
								<h5><i class="fa fa-comment"></i> Kommentar</h5>

								<div class="mt-3">
									<p>Du möchtest diskutieren oder einen Kommentar zu dem Beitrag hinterlassen?</p>
									<small class="text-muted">Dieser Blog hat keine öffentliche Kommentarfunktion, aber ich freue mich jederzeit über eine
										<a href="mailto:rollin.hand@gmx.de">Mail</a> mit kritischen Anmerkungen, Feedback oder auch einfach nur
										Lob an meine Mail-Adresse <a href="mailto:rollin.hand@gmx.de">rollin.hand[@]gmx.de</a>.</small>
								</div>
							</div>
						</div>
					</section>
				</div>
			</div>
		</div>
	</section>
</main>
<!-- HTML5 FOOTER -->
<footer class="bg-dark py-4 mt-auto">
    <div class="container px-5">
        <div class="row align-items-center justify-content-between flex-column flex-sm-row">
            <div class="col-auto">
                <div class="small m-0 text-white">Copyright &copy; 2017 - 2025 by Björn Berg (Last update: 2025-06-09)</div>
            </div>
            <div class="col-auto">
                <a class="link-light small" href="../../../../../blog/meecrowave.html">Apache Meecrowave</a>
                <span class="text-white mx-1">&middot;</span>
                <a class="link-light small" href="../../../../../privacy-policy/index.html">Privacy</a>
                <span class="text-white mx-1">&middot;</span>
                <a class="link-light small" href="../../../../../about/index.html">Imprint</a>
                <span class="text-white mx-1">&middot;</span>
                <a class="link-light small" href="mailto:rollin.hand@gmx.de">Contact</a>
            </div>
            <div class="col-auto">
                <a class="link-light text-decoration-none mx-1 small" href="https://www.xing.com/profile/Bjoern_Berg2" target="_blank" rel="me">
                    <span class="button xing" aria-details="Xing"><i class="fab fa-xing"></i></span>
                </a>
                <a class="link-light text-decoration-none mx-1 small" href="https://www.linkedin.com/in/bjoernberg82" target="_blank" rel="me">
                    <span class="button linkedin" aria-details="LinkedIn"><i class="fab fa-linkedin"></i></span>
                </a>
                <a class="link-light text-decoration-none mx-1 small" href="../../../../../feed.xml">
                    <span class="button atom" aria-details="Atom/RSS"><i class="fas fa-rss subscribe"></i></span>
                </a>
            </div>
        </div>
    </div>
</footer>
<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Core theme JS-->
<script src="js/scripts.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>